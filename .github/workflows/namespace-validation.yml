name: SPI Comprehensive Validation

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**/*.py'
      - 'scripts/validation/**'
      - '.github/workflows/namespace-validation.yml'
  pull_request:
    branches: [main, develop, development]
    paths:
      - 'src/**/*.py'
      - 'scripts/validation/**'
  workflow_dispatch:

jobs:
  # ============================================================================
  # NEW: Standalone Python Validators (stdlib only, no omnibase_core)
  # ============================================================================
  standalone-validators:
    name: Standalone SPI Validators
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # No uv needed - these validators use only stdlib
      - name: Run Naming Pattern Validation
        run: python scripts/validation/validate_naming_patterns.py src/

      - name: Run Namespace Isolation Validation
        run: python scripts/validation/validate_namespace_isolation.py

      - name: Run Architecture Validation (informational)
        # Architecture validation fails due to existing technical debt (92 files)
        # Run for visibility but don't fail the build
        continue-on-error: true
        run: python scripts/validation/validate_architecture.py --verbose

      - name: Run Unified Validation Suite
        run: |
          echo "Running unified validation suite..."
          # Generate JSON report for artifact upload (allow failure to capture results)
          python scripts/validation/run_all_validations.py --json > validation_results.json || true
          # Run with verbose output for CI logs
          python scripts/validation/run_all_validations.py --verbose

      - name: Run SPI Validations
        run: |
          # Validate critical SPI requirements
          # This step uses check_results.py which distinguishes:
          # - CRITICAL validators (naming_patterns, namespace_isolation) - must pass
          # - INFORMATIONAL validators (architecture) - known technical debt, reported only
          # Build fails if any critical validator fails
          python scripts/validation/check_results.py

      - name: Upload validation results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: standalone-validation-results
          path: validation_results.json
          retention-days: 14

  # ============================================================================
  # Full validation with uv dependencies
  # ============================================================================
  validate-namespace-isolation:
    runs-on: ubuntu-latest
    needs: standalone-validators

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: '**/uv.lock'

      - name: Install dependencies
        run: uv sync --group dev

      - name: Run namespace isolation validation
        run: |
          chmod +x ./scripts/validate-namespace-isolation.sh
          ./scripts/validate-namespace-isolation.sh

      - name: Run SPI purity validation
        continue-on-error: true
        run: |
          chmod +x ./scripts/validate-spi-purity.sh
          ./scripts/validate-spi-purity.sh

      - name: Run protocol import tests
        run: |
          uv run pytest tests/test_protocol_imports.py -v --tb=short

      - name: Run all tests
        run: |
          uv run pytest tests/ -v --tb=short

      - name: Validate package can be built
        run: uv build

      - name: Test package installation in isolation
        run: |
          # Create a clean virtual environment to test installation
          python -m venv /tmp/test-env
          source /tmp/test-env/bin/activate
          pip install dist/*.whl
          python -c "
          import sys
          print('Testing import isolation...')

          # Should be able to import omnibase_spi.protocols without any external dependencies
          from omnibase_spi.protocols.types import LiteralLogLevel, ProtocolLogEntry

          # Verify no external omnibase modules are loaded
          external_modules = [name for name in sys.modules.keys()
                            if name.startswith('omnibase_spi.') and not name.startswith('omnibase_spi.protocols')]

          if external_modules:
              print(f'FAILURE: External omnibase modules loaded: {external_modules}')
              sys.exit(1)
          else:
              print('SUCCESS: No external omnibase dependencies loaded!')
          "

  validate-documentation:
    runs-on: ubuntu-latest
    needs: validate-namespace-isolation

    steps:
      - uses: actions/checkout@v4

      - name: Validate README and documentation
        run: |
          # Ensure the README mentions the namespace isolation
          if ! grep -q "namespace.*isolat" README.md; then
            echo "WARNING: README should mention namespace isolation"
          fi

          # Check that version is consistent across files
          VERSION=$(grep '^version = ' pyproject.toml | cut -d'"' -f2)
          if ! grep -q "__version__ = \"$VERSION\"" src/omnibase_spi/__init__.py; then
            echo "ERROR: Version mismatch between pyproject.toml and __init__.py"
            exit 1
          fi
